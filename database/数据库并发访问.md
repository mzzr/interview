# 并发访问导致的数据读取问题

## 脏读（读取未提交数据）
A事务读取B事务尚未提交的数据，此时如果B事务发生错误并执行回滚操作，那么A事务读取到的数据就是脏数据。就好像原本的数据比较干净、纯粹，此时由于B事务更改了它，这个数据变得不再纯粹。这个时候A事务立即读取了这个脏数据，但事务B发生错误，回滚将数据恢复成原来干净、纯粹的样子，而事务A却什么都不知道，最终结果就是事务A读取了此次的脏数据，称为脏读。

## 不可重复读（前后多次读取，数据内容不一致）
事务A在执行读取操作，由于整个事务A比较大，前后读取同一条数据需要经历很长的时间。而在事务A第一次读取数据，事务B执行更改操作，此时事务A第二次读取数据，发现和之前的数据不一样，也就是数据不重复，系统不可以读取到重复的数据，称为不可重复读。

## 幻读（前后多次读取，数据总量不一致）
事务A在执行读取操作，需要统计数据的总量，前一次查询数据总量后，此时事务B执行了新增数据的操作并提交后，这个时候事务A读取的数据总量和之前统计的不一样，就像产生了幻觉一样，平白无故的多了几条数据，称为幻读

### 不可重复读和幻读到底有什么区别？
- 不可重复读是读取了其他事务更改的数据，针对update操作
解决：使用行级锁。锁定该行，事务A多次读取操作完成后才释放该锁，这个时候才允许其他事务更改刚才的数据。

- 幻读是读取了其他事务新增的数据，针对insert操作
解决：使用表级锁，锁定整张表，事务A多次读取数据总量之后才释放该锁，这个时候才允许其他事务新增数据。

## 事务的隔离级别

- 脏读：一个事务会读进还没有被另一个事务提交的数据，所以你会看到一些最后被一个事务回滚掉的数据。
- 不可重复读：一个事务读进一条记录，另一个事务更改了这条记录并提交完毕，这时候第一个事务再次读这条记录时，它已经改变了。
- 幻读：一个事务用Where子句来检索一个表的数据，另一个事务插入了一条新的记录，并且符合Where条件，这样，第一个事务用同一个where条件来检索数据后，就会多出一条记录。

数据库提供了四种事务隔离级别，不同的隔离级别采用不同的锁来实现。
在四种隔离级别中，Serializable的级别最高，Read uncommitted的级别最低，大多数数据库的默认隔离级别为：Read committed，如Sql Server, Oracle
少数数据库默认的隔离级别为Repeatable Read，如MySQL InnoDB

## SQL SERVER锁的机制
SQL server的所有活动都会产生锁。锁定的单元越小，就越能提高并发处理能力，但是管理锁的开销越大。

1. 共享锁
用于只读操作（SELECT），锁定共享的资源。共享锁不会阻止其他用户读，但是阻止其他的用户写和修改。

2. 更新锁
更新锁是一种意图锁，当一个事务已经请求共享锁后并试图请求一个独占锁的时候发生更新锁。

3. 独占锁
一次只能有一个独占锁用在一个资源上，并且阻止其他所有锁包括共享锁。写是独占锁，可以有效防止“脏读”

4. 意图锁
在使用共享锁和独占锁之前，使用意图锁。从表的层次上查看意图锁，以判断事务能否获得共享锁和独占锁，提高了系统的性能，不需要从页或行上检查

5. 计划锁
Sch-M，Sch-S。对数据库结构改变时用Sch-M，对查询进行编译时用Sch-S，这两种锁不会阻塞任何事务锁，包括独占锁。

读是共享锁，写是排他锁，先读后更新是更新锁，更新锁成功并且改变了数据时更新锁升级为排他锁


- ReadCommitted： 
假设A事务对正在读取数据Data放置了共享锁，那么Data不能被其它事务改写，所以当B事务对Data进行读取时总和A读取的Data数据是一致的，所以避免了脏读。由于在A没有提交之前可以对Data进行改写，那么B读取到的某个值可能会在其读取后被A更改从而导致了该值不能被重复取得；或者当B再次用相同的where字句时得到了和前一次不一样数据的结果集，也就是幻像数据。

- ReadUncommitted：
假设A事务即不发布共享锁，也不接受独占锁，那么并发的B或者其它事务可以改写A事务读取的数据，那么并发的C事务读取到的数据的状态和A的或者B的数据都可能不一致，那么。脏读、不可重复读、幻象数据都可能存在。

- RepeatableRead：
（注意MSDN原文中的第一句话：在查询中使用的所有数据上放置锁，所以不存在脏读的情况）。
假设A事务对读取的所有数据Data放置了锁，以阻止其它事务对Data的更改，在A没有提交之前，新的并发事务读取到的数据如果存在于Data中，那么该数据的状态和A事务中的数据是一致的，从而避免了不可重复的读取。但在A事务没有结束之前，B事务可以插入新记录到Data所在的表中，那么其它事务再次用相同的where字句查询时，得到的结果数可能上一次的不一致，也就是幻像数据。

- Serializable：
 在数据表上放置了排他锁，以防止在事务完成之前由其他用户更新行或向数据集中插入行，这是最严格的锁。它防止了脏读、不可重复读取和幻象数据。
 